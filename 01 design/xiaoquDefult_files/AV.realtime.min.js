!function e(t,n,r){function o(a,c){if(!n[a]){if(!t[a]){var s="function"==typeof require&&require;if(!c&&s)return s(a,!0);if(i)return i(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var d=n[a]={exports:{}};t[a][0].call(d.exports,function(e){var n=t[a][1][e];return o(n?n:e)},d,d.exports,e,t,n,r)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<r.length;a++)o(r[a]);return o}({1:[function(e,t,n){(function(t){"use strict";var n=t.AV=t.AV||{};n.realtime=e("./realtime")}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./realtime":2}],2:[function(e,t,n){(function(r){"use strict";var o=e("./tool"),i=o.ajax,a=o.extend,c="2.3.0",s={heartbeatsTime:6e4,WebSocket:e("ws")},u={},d={open:"open",reuse:"reuse",close:"close",create:"create",join:"join",left:"left",invited:"invited",kicked:"kicked",membersjoined:"membersjoined",membersleft:"membersleft",message:"message",receipt:"receipt",update:"update",error:"error"},l=function(e){var t=function(t,n,r,o){var i,a,c,s=[];switch("string"==typeof n?s.push(n):s=n,i={cid:t,members:s,serialId:u.getSerialId(e)},o){case"add":c="conv-added",u.convAdd(e,i);break;case"remove":c="conv-removed",u.convRemove(e,i)}return a=function(t){t.i===i.serialId&&(r&&r(t),e.ec.off(c,a))},e.ec.on(c,a),this};return{id:"",attr:{},add:function(e,n){return t(this.id,e,n,"add"),this},remove:function(e,n){return t(this.id,e,n,"remove"),this},join:function(t){return this.add(e.options.peerId,t),this},leave:function(t){return this.remove(e.options.peerId,t),this},send:function(t,n,r){var o,i={},a=this;switch(arguments.length){case 2:o=n;break;case 3:i=n,o=r}if(i.cid=a.id,i.serialId=u.getSerialId(e),i.type?i.data=u.setMediaMsg(e,i.type,t):"string"==typeof t?i.data=t:i.data=JSON.stringify(t),i.receipt&&(i.receipt=1),!i["transient"]){var c=function s(t){t.i===i.serialId&&(o&&o(t),e.ec.off("ack",s))};e.ec.on("ack",c)}return u.send(e,i,o),this},log:function(t,n){var r={};switch(arguments.length){case 1:n=t;break;case 2:r=t}r.cid=r.cid||this.id,r.serialId=r.serialId||u.getSerialId(e);var o=function i(t){if(t.i===r.serialId){if(n){for(var o=0,a=t.logs.length;a>o;o++)t.logs[o].data=u.getMediaMsg(e,t.logs[o].data),t.logs[o].fromPeerId=t.logs[o].from,t.logs[o].msg=t.logs[o].data;n(t.logs)}e.ec.off("logs",i)}};return e.ec.on("logs",o),u.convLog(e,r),this},receive:function(t){var n=this.id;return e.ec.on(d.message,function(e){n===e.cid&&t(e)}),this},receipt:function(t){var n=this.id;return e.ec.on(d.receipt,function(e){n===e.cid&&t(e)}),this},list:function(t){var n={},r=this.id;n.where={objectId:r},n.serialId=u.getSerialId(e);var o=function i(r){r.i===n.serialId&&(t&&t(r.results.length?r.results[0].m:[]),e.ec.off("conv-results",i))};return e.ec.on("conv-results",o),u.convQuery(e,n),this},count:function(t){var n=this.id,r={cid:n,serialId:u.getSerialId(e)},o=function i(n){n.i===r.serialId&&(t&&t(n.count),e.ec.off("conv-result",i))};return e.ec.on("conv-result",o),u.convCount(e,r),this},update:function(t,n){var r=this.id,o={cid:r,data:t,serialId:u.getSerialId(e)},i=function a(t){t.i===o.serialId&&(n&&n(t),e.ec.off("conv-updated",a))};return e.ec.on("conv-updated",i),u.convUpdate(e,o),this}}},f=function(){var e={options:void 0,ws:void 0,ec:void 0,conv:{},openFlag:!1,closeFlag:!1,reuseTimer:void 0,reuseFlag:!1,serialId:2015};return{clientId:"",cache:e,open:function(e){var t=this,n=this.cache;return n.closeFlag=!1,u.getServer(n,n.options,function(e){e&&u.connect(n,{server:n.server})}),e&&n.ec.once(d.open,e),n.ec.once(d.reuse,function(){n.reuseTimer&&clearTimeout(n.reuseTimer),n.reuseTimer=setTimeout(function(){t.open()},5e3)}),this},close:function(){var e=this.cache;if(!e.openFlag)throw new Error("Must call after open() has successed.");return e.closeFlag=!0,u.closeSession(e),e.ws.close(),this},on:function(e,t){return this.cache.ec.on(e,t),this},once:function(e,t){return this.cache.ec.once(e,t),this},emit:function(e,t){return this.cache.ec.emit(e,t),this},off:function(e,t){return this.cache.ec.off(e,t),this},room:function(e,t){var n=this.cache;if(!n.openFlag)throw new Error("Must call after open() has successed.");var r;if("string"==typeof e){var o=e;r=n.conv[o]?n.conv[o]:l(n),this.query({where:{objectId:o}},function(e){e.length&&(r.id=o,r.name=e[0].name,r.attr=e[0].attr,n.conv[o]=r),t&&t(e.length?r:null)})}else{if(!e)throw new Error("Createing room must have a callback function.");var i;"function"==typeof e?t=e:i=e,i={name:i.name||"",members:i.members||[],attr:i.attr||{},"transient":i["transient"]||!1,serialId:u.getSerialId(n)},r=l(n),u.startConv(n,i,t);var a=function c(e){e.i===i.serialId&&(r.id=e.cid,r.name=i.name,r.attr=i.attr,n.conv[r.id]=r,t&&t(r),n.ec.emit(d.create,e),n.ec.off("conv-started",c))};n.ec.on("conv-started",a)}return r},conv:function(){return this.room.apply(this,arguments)},query:function(e,t){var n=this.cache;if(!n.openFlag)throw new Error("Must call after open() has successed.");var r={};switch(arguments.length){case 1:t=e;break;case 2:r=e}r.serialId=u.getSerialId(n);var o=function i(e){e.i===r.serialId&&(t&&t(e.results),n.ec.off("conv-results",i))};return n.ec.on("conv-results",o),u.convQuery(n,r),this},ping:function(e,t){var n=this.cache;if(!n.openFlag)throw new Error("Must call after open() has successed.");if(!t)throw new Error("Ping must have callback.");var r=[];"string"==typeof e?r.push(e):r=e;var o={serialId:u.getSerialId(n),peerIdList:r},i=function a(e){e.i===o.serialId&&(t(e.onlineSessionPeerIds),n.ec.off("session-query-result",a))};return n.ec.on("session-query-result",i),u.querySession(n,o),this}}},m=function(e,t){if("object"!=typeof e)throw new Error("realtime need a argument at least.");if(!e.appId)throw new Error("Options must have appId.");if(s.WebSocket){var n=s.WebSocket.loadFlashPolicyFile?!1:!0;e={appId:e.appId,peerId:e.clientId,encodeHTML:e.encodeHTML||!1,auth:e.auth,secure:"undefined"==typeof e.secure?n:e.secure,region:e.region||"cn"};var r=f();return r.clientId=e.clientId,r.cache.options=e,r.cache.ec=o.eventCenter(),r.cache.authFun=e.auth,r.open(t),r}console.error("Browser must support WebSocket, please read LeanCloud doc and use plugin.")};m.version=c,m._tool=o,m._engine=u,m.config=function(e){a(s,e)},u.wsOpen=function(e){u.bindEvent(e),u.openSession(e,{serialId:u.getSerialId(e)}),u.heartbeats(e),u.guard(e)},u.wsClose=function(e,t){e.ec.emit(d.close,t)},u.wsMessage=function(e,t){var n=JSON.parse(t.data);if(n.cmd){var r=n.cmd;n.op&&(r+="-"+n.op),e.ec.emit(r,n)}},u.wsError=function(e,t){throw e.ec.emit(d.error,t),t},u.wsSend=function(e,t){if(!e.closeFlag){if(!e.ws)throw new Error('The realtimeObject must opened first. Please listen to the "open" event.');t.peerId=e.options.peerId,e.ws.send(JSON.stringify(t))}},u.createSocket=function(e,t){e.ws&&e.ws.close();var n=new s.WebSocket(t);e.ws=n,n.addEventListener("open",function(){u.wsOpen(e)}),n.addEventListener("close",function(t){u.wsClose(e,t)}),n.addEventListener("message",function(t){u.wsMessage(e,t)}),n.addEventListener("error",function(t){u.wsError(e,t)})},u.heartbeats=function(e){if(!e.openFlag){var t;e.ws.addEventListener("message",function(){t&&clearTimeout(t),t=setTimeout(function(){e.ws.send("{}")},s.heartbeatsTime)})}},u.guard=function(e){if(!e.openFlag){var t,n=18e4;e.ws.addEventListener("message",function(){t&&clearTimeout(t),t=setTimeout(function(){e.closeFlag||e.reuseFlag||(e.reuseFlag=!0,e.ec.emit(d.reuse))},n)}),e.ec.on(d.close+" session-closed",function(){e.closeFlag||e.reuseFlag||(e.reuseFlag=!0,e.ec.emit(d.reuse))})}},u.connect=function(e,t){var n=t.server;if(!(n&&o.now()<=n.expires))throw e.ec.emit(d.error),new Error("WebSocket connet failed.");u.createSocket(e,n.server)},u.getServer=function(e,t,n){var a=t.appId,c=t.secure,s="",u="http://";r.location&&"https:"===r.location.protocol&&c&&(u="https://");var l="";switch(t.region){case"cn":l="g0";break;case"us":l="a0";break;default:throw new Error("There is no this region.")}s=u+"router-"+l+"-push.leancloud.cn/v1/route",s+="?_t="+o.now()+"&appId="+a,c&&(s+="&secure=1"),i(s,function(t,r){r?(r.expires=o.now()+1e3*r.ttl,e.server=r,n(r)):e.ec.emit(d.error)})},u.openSession=function(e,t){var n={cmd:"session",op:"open",appId:e.options.appId,ua:"js/"+c,i:t.serialId};e.authFun?e.authFun({clientId:e.options.peerId},function(t){if(!t||!t.signature)throw new Error("Session open denied by application: "+t);n.n=t.nonce,n.t=t.timestamp,n.s=t.signature,u.wsSend(e,n)}):u.wsSend(e,n)},u.closeSession=function(e){u.wsSend(e,e,{cmd:"session",op:"close"})},u.startConv=function(e,t){var n={cmd:"conv",op:"start",m:t.members,attr:{name:t.name||"",attr:t.attr||{}},i:t.serialId,"transient":t["transient"]||!1};e.authFun?e.authFun({clientId:e.options.peerId,members:t.members},function(t){if(!t||!t.signature)throw new Error("Conversation creation denied by application: "+t);n.n=t.nonce,n.t=t.timestamp,n.s=t.signature,u.wsSend(e,n)}):u.wsSend(e,n)},u.convAdd=function(e,t){var n={cmd:"conv",op:"add",cid:t.cid,m:t.members,i:t.serialId};e.authFun?e.authFun({clientId:e.options.peerId,members:t.members,convId:t.cid,action:"invite"},function(t){if(!t||!t.signature)throw new Error("Adding members to conversation denied by application: "+t);n.n=t.nonce,n.t=t.timestamp,n.s=t.signature,u.wsSend(e,n)}):u.wsSend(e,n)},u.convRemove=function(e,t){var n={cmd:"conv",op:"remove",cid:t.cid,m:t.members,i:t.serialId};e.authFun&&(t.members.length>1||t.members[0]!=e.options.peerId)?e.authFun({clientId:e.options.peerId,members:t.members,convId:t.cid,action:"kick"},function(t){if(!t||!t.signature)throw new Error("Removing members from conversation denied by application: "+t);n.n=t.nonce,n.t=t.timestamp,n.s=t.signature,u.wsSend(e,n)}):u.wsSend(e,n)},u.send=function(e,t){u.wsSend(e,{cmd:"direct",cid:t.cid,msg:t.data,i:t.serialId,r:t.receipt||!1,"transient":t["transient"]||!1})},u.convQuery=function(e,t){t=t||{},u.wsSend(e,{cmd:"conv",op:"query",where:t.where||{m:e.options.peerId},sort:t.sort||"-lm",limit:t.limit||10,skip:t.skip||0,i:t.serialId})},u.querySession=function(e,t){u.wsSend(e,{cmd:"session",op:"query",i:t.serialId,sessionPeerIds:t.peerIdList})},u.convLog=function(e,t){u.wsSend(e,{cmd:"logs",cid:t.cid,t:t.t||void 0,mid:t.mid||void 0,limit:t.limit||20,i:t.serialId})},u.convUpdate=function(e,t){u.wsSend(e,{cmd:"conv",op:"update",cid:t.cid,attr:t.data,i:t.serialId})},u.convAck=function(e,t){u.wsSend(e,{cmd:"ack",cid:t.cid,mid:t.mid})},u.convCount=function(e,t){u.wsSend(e,{cmd:"conv",op:"count",i:t.serialId,cid:t.cid})},u.getMediaMsg=function(e,t){if(!o.isJSONString(t))return e.options.encodeHTML&&(t=o.encodeHTML(t)),t;if(t=JSON.parse(t),!t.hasOwnProperty("_lctype"))return t;var n={text:t._lctext,attr:t._lcattrs};switch(e.options.encodeHTML&&(n.text=o.encodeHTML(t._lctext)),t._lcfile&&t._lcfile.url&&(n.url=t._lcfile.url),t._lcfile&&t._lcfile.metaData&&(n.metaData=t._lcfile.metaData),t._lctype){case-1:n.type="text";break;case-2:n.type="image";break;case-3:n.type="audio";break;case-4:n.type="video";break;case-5:n.type="location";break;case-6:n.type="file";break;default:n=t}return n},u.setMediaMsg=function(e,t,n){var r;if("text"!==t&&!n.metaData)throw new Error("Media Data must have metaData attribute.");switch(t){case"text":r={_lctype:-1,_lctext:n.text,_lcattrs:n.attr};break;case"image":r={_lctype:-2,_lctext:n.text,_lcattrs:n.attr,_lcfile:{url:n.url,objId:n.objectId,metaData:{name:n.metaData.name,format:n.metaData.format,height:n.metaData.height,width:n.metaData.width,size:n.metaData.size}}};break;case"audio":r={_lctype:-3,_lctext:n.text,_lcattrs:n.attr,_lcfile:{url:n.url,objId:n.objectId,metaData:{name:n.metaData.name,format:n.metaData.format,duration:n.metaData.duration,size:n.metaData.size}}};break;case"video":r={_lctype:-4,_lctext:n.text,_lcattrs:n.attr,_lcfile:{url:n.url,objId:n.objectId,metaData:{name:n.metaData.name,format:n.metaData.format,duration:n.metaData.duration,size:n.metaData.size}}};break;case"location":r={_lctype:-5,_lctext:n.text,_lcattrs:n.attr,_lcloc:{longitude:n.metaData.longitude,latitude:n.metaData.latitude}};break;case"file":r={_lctype:-6,_lctext:n.text,_lcattrs:n.attr,_lcfile:{name:n.metaData.name,size:n.metaData.size}}}return r=JSON.stringify(r)},u.getSerialId=function(e){return e.serialId++,e.serialId>999999&&(e.serialId=2015),e.serialId},u.bindEvent=function(e){e.openFlag||(e.ec.on("session-opened",function(t){e.reuseFlag=!1,e.openFlag=!0,e.ec.emit(d.open,t)}),e.ec.on("session-error",function(t){e.ec.emit(d.error,t)}),e.ec.on("conv-joined",function(t){t.peerId!==t.initBy&&e.ec.emit(d.join,t),e.ec.emit(d.invited,t)}),e.ec.on("conv-left",function(t){e.ec.emit(d.left,t),e.ec.emit(d.kicked,t)}),e.ec.on("conv-members-joined",function(t){e.ec.emit(d.join,t),e.ec.emit(d.membersjoined,t)}),e.ec.on("conv-members-left",function(t){e.ec.emit(d.left,t),e.ec.emit(d.membersleft,t)}),e.ec.on("conv-error",function(t){throw e.ec.emit(d.error,t),t.code+":"+t.reason}),e.ec.on("direct",function(t){t.msg=u.getMediaMsg(e,t.msg),t["transient"]||u.convAck(e,{cid:t.cid,mid:t.id}),e.ec.emit(d.message,t)}),e.ec.on("rcp",function(t){e.ec.emit(d.receipt,t)}))},"undefined"!=typeof n?("undefined"!=typeof t&&t.exports&&(n=t.exports=m),n.realtime=m):"function"==typeof define&&define.amd&&define("AV/realtime",[],function(){return m})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./tool":6,ws:7}],3:[function(e,t,n){(function(n){"use strict";t.exports=function(t,r){"string"==typeof t&&(t={url:t});var o=t.url,i=t.method||"get",a=e("xmlhttprequest").XMLHttpRequest,c=new a;n.XDomainRequest&&(c=new n.XDomainRequest),c.open(i,o),c.onload=function(e){c.status>=200&&c.status<300||n.XDomainRequest&&!c.status?r(null,JSON.parse(c.responseText)):r(JSON.parse(c.responseText))},c.onerror=function(e){throw r(e||{}),new Error("Network error.")},c.onprogress=function(){},c.ontimeout=function(){},c.timeout=0;var s=JSON.stringify(t.data);c.send(s)}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{xmlhttprequest:8}],4:[function(e,t,n){"use strict";t.exports=function(){function e(e){var t=[],n=0,r=e.length;if(r){for(;r>n;n++)e[n]&&t.push(e[n]);return t}return null}var t={},n={},r=function(e,r,o){if(!e)throw new Error("No event name.");if(!r)throw new Error("No callback function.");var i,a,c,s=e.split(/\s+/);o&&(a=o.once,c=o.single),i=a?n:t;for(var u=0,d=s.length;d>u;u++)if(s[u]){var l=i[s[u]];if(l||(l=[],i[s[u]]=l),c){for(var f=!1,m=0,p=l.length;p>m;m++)if(l[m].toString()===r.toString()){f=!0;break}f||l.push(r)}else l.push(r)}},o=function(e,r,o){var i,a;if(o&&(a=o.once),i=a?n:t,i[e])for(var c=0,s=i[e].length;s>c;c++)if(i[e][c]===r){i[e][c]=null;break}};return{on:function(e,t){return r(e,t),this},once:function(e,t){return r(e,t,{once:!0}),this},_one:function(e,t){r(e,t,{single:!0})},emit:function(r,i){if(!r)throw new Error("No emit event name.");var a=0,c=0;if(t[r]){for(a=0,c=t[r].length;c>a;a++)t[r][a]&&t[r][a].call(this,i);t[r]=e(t[r])}if(n[r]){for(a=0,c=n[r].length;c>a;a++)n[r][a]&&(n[r][a].call(this,i),o(r,n[r][a],{once:!0}));n[r]=e(n[r])}return this},off:function(e,t){return o(e,t),this}}}},{}],5:[function(e,t,n){"use strict";var r=Object.prototype.hasOwnProperty,o=Object.prototype.toString,i=function(e){return"function"==typeof Array.isArray?Array.isArray(e):"[object Array]"===o.call(e)},a=function(e){if(!e||"[object Object]"!==o.call(e))return!1;var t=r.call(e,"constructor"),n=e.constructor&&e.constructor.prototype&&r.call(e.constructor.prototype,"isPrototypeOf");if(e.constructor&&!t&&!n)return!1;var i;for(i in e);return"undefined"==typeof i||r.call(e,i)};t.exports=function c(){var e,t,n,r,o,s,u=arguments[0],d=1,l=arguments.length,f=!1;for("boolean"==typeof u?(f=u,u=arguments[1]||{},d=2):("object"!=typeof u&&"function"!=typeof u||null===u)&&(u={});l>d;++d)if(e=arguments[d],null!==e)for(t in e)n=u[t],r=e[t],u!==r&&(f&&r&&(a(r)||(o=i(r)))?(o?(o=!1,s=n&&i(n)?n:[]):s=n&&a(n)?n:{},u[t]=c(f,s,r)):"undefined"!=typeof r&&(u[t]=r));return u}},{}],6:[function(e,t,n){"use strict";var r={};r.ajax=e("./ajax"),r.extend=e("./extend"),r.eventCenter=e("./eventcenter"),r.noop=function(){},r.isJSONString=function(e){return/^\{.*\}$/.test(e)},r.now=function(){return(new Date).getTime()},r.encodeHTML=function(e){var t=function(e){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):e};if("object"==typeof e){for(var n in e)e[n]=r.encodeHTML(e[n]);return e}return t(e)},t.exports=r},{"./ajax":3,"./eventcenter":4,"./extend":5}],7:[function(e,t,n){function r(e,t,n){var r;return r=t?new i(e,t):new i(e)}var o=function(){return this}(),i=o.WebSocket||o.MozWebSocket;t.exports=i?r:null,i&&(r.prototype=i.prototype)},{}],8:[function(e,t,n){n.XMLHttpRequest=window.XMLHttpRequest||window.XDomainRequest},{}]},{},[1]);